{% extends 'base.html' %}

{% block style %}
p {
  margin-bottom: 0;
}
a {
  color: white;
}
ul {
  padding-left: 0;
}
li {
  list-style: none;
}
button {
  background: none;
  border: none;
  outline: 0;
  color: white;
}
.navbar__profile {
  display: flex;
  align-items: center;
}
.container {
  max-width: 700px;
  margin: 75px auto;
}
.user-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
}
.review-profile-image img {
  width: 35px;
  border-radius: 50%;
}
.review-created-time {
  color: rgb(173, 173, 173);
  font-size: 12px;
}
.movie-header {
  border-bottom: 1px solid #5f5f5f;
  padding-bottom: 10px;
}
.movie-header > div > a {
  display: flex;
  align-items: center;
  gap: 20px;
}
.movie-poster img {
  width: 60px;
  border-radius: 6px;
}
.review-content {
  margin: 20px 0;
  min-height: 100px;
}
.review-sub {
  color: #8d8d8d;
  font-size: 12px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
}
.my-btn {
  display: flex;
  justify-content: center;
}
.my-btn form, .my-btn a {
  padding: 5px;
}
.my-btn form:hover,  .my-btn a:hover {
  background-color: #444444;
  border-radius: 5px;
}
.icon-container {
  border-top: 1px solid #5f5f5f;
  border-bottom: 1px solid #5f5f5f;
  padding: 10px 0;
}
.icon-container {
  display: flex;
  justify-content: space-around;
}
.icon-container button, a {
  display: flex;
  align-items: center;
  gap: 10px;
} 
.comments-container {
  margin-top: 50px;
}
.comment-item {
  display: flex;
  gap: 10px;
  border-bottom: 1px solid #444444;
  padding: 10px 0;
}
.comment-profile-image img {
  width: 40px;
  border-radius: 50%;
}
.comment-content {
  width: 100%;
}
.comment-info {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.comment-profile-nickname {
  font-weight: 700;
}
.comment-created-time {
  color: #8d8d8d;
  font-size: 14px;
}
.comment-desc {
  margin-top: 10px;
}
.comment-like-btn {
  display: flex;
  align-items: center;
  gap: 3px;
  padding: 0;
  color: rgba(255, 255, 255, 0.548);
  font-size: 14px;
  margin-top: 10px;
}
{% endblock style %}

{% block content %}
<div class="review-container">
  <div class="review-item">
    <div class="user-header">
      <div class="review-profile-image">
        <a href="{% url 'accounts:profile' review.user.email %}">
          <img src="{{ review.user.profile_image.url }}" alt="{{ review.user.profile_image }}">
        </a>
      </div>
      <a href="{% url 'accounts:profile' review.user.email %}">
        <p class="review-profile-nickname">{{ review.user.nickname }}</p>
      </a>
      <p class="review-created-time">{{ review.created_at }}</p>
    </div>
    <div class="movie-header">
      <div class="movie-poster">
        <a href="{% url 'movies:detail' review.movie.pk %}">
          <img src="https://www.themoviedb.org/t/p/w300_and_h450_bestv2/{{ review.movie.poster_path }}" alt="">
          <p>{{ review.movie.title }}</p>
        </a>
      </div>
    </div>
    <div class="review-content">
      {{ review.content }}
    </div>
    <div class="review-sub">
      <div>
        <span>좋아요 {{ review.like_users.all|length }}</span> ·
        <span>댓글 {{ review.comment_set.all|length }}</span>
      </div>
      {% if request.user == review.user %}
      <div class="my-btn">
        <a href="{% url 'reviews:update' review.pk %}">
          <button>수정하기</button>
        </a>
        <form action="{% url 'reviews:delete' review.pk %}" method="POST">
          {% csrf_token %}
          <button>삭제하기</button>
        </form>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="icon-container">
    <form action="#">
      <button class="like">
        <p class="icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="Interface / Heart_01"> <path id="Vector" d="M12 7.69431C10 2.99988 3 3.49988 3 9.49991C3 15.4999 12 20.5001 12 20.5001C12 20.5001 21 15.4999 21 9.49991C21 3.49988 14 2.99988 12 7.69431Z" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path> </g> </g></svg>
        </p>
        <p>{{ review.like_users.all|length }}</p>
      </button>
    </form>
    <a class="comment" href="#">
      <p class="icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g clip-path="url(#clip0_429_11233)"> <path d="M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 13.4876 3.36093 14.891 4 16.1272L3 21L7.8728 20C9.10904 20.6391 10.5124 21 12 21Z" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path> </g> <defs> <clipPath id="clip0_429_11233"> <rect width="24" height="24" fill="white"></rect> </clipPath> </defs> </g></svg></p>
      <p>{{ review.comment_set.all|length }}</p>
    </a>
  </div>
    
  <div class="comments-container">
    <ul>
      {% for comment in comments %}
      <li>
        <div class="comment-item">
          <div class="comment-profile-image">
            <a href="{% url 'accounts:profile' comment.user.email %}">
              <img src="{{ comment.user.profile_image.url }}" alt="{{ comment.user.profile_image }}">
            </a>
          </div>
          <div class="comment-content">
            <div class="comment-info">
              <div class="comment-profile-nickname">{{ comment.user.nickname }}</div>
              <div class="comment-created-time">{{ comment.created_at }}</div>
            </div>
            <div class="comment-desc">
              {{ comment.content }}
            </div>
            <div class="comment-like">
              <form class="comment-like-forms" data-comment-id="{{ comment.pk }}" {% if not user.is_authenticated %}disabled{% endif %}>
                {% csrf_token %}
                {% if request.user != comment.user %}
                  {% if request.user in comment.like_users.all %}
                  <button class="comment-like-btn" id="likes_comment-{{comment.pk}}">
                  <svg width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="Interface / Heart_01"> <path id="Vector" d="M12 7.69431C10 2.99988 3 3.49988 3 9.49991C3 15.4999 12 20.5001 12 20.5001C12 20.5001 21 15.4999 21 9.49991C21 3.49988 14 2.99988 12 7.69431Z" stroke="#ff4d4d" fill="#ff4d4d" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path> </g> </g></svg>
                  <p>{{ comment.like_users.all|length }}</p>
                  </button>
                  {% else %}
                  <button class="comment-like-btn" id="likes_comment-{{comment.pk}}">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="Interface / Heart_01"> <path id="Vector" d="M12 7.69431C10 2.99988 3 3.49988 3 9.49991C3 15.4999 12 20.5001 12 20.5001C12 20.5001 21 15.4999 21 9.49991C21 3.49988 14 2.99988 12 7.69431Z" stroke="#98A0A0" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path> </g> </g></svg>
                  <p>{{ comment.like_users.all|length }}</p>
                  </button>
                  {% endif %}
                {% endif %}
              </form>
            </div>
          </div>
        </div>
      </li>
      {% empty %}
      <li>
        가장 먼저 댓글을 작성해보세요!
      </li>
      {% endfor %}
    </ul>

  </div>

</div>
{% endblock content %}

{% block script %}
<script>
  // Comment like buttons
  const commentForms = document.querySelectorAll('.comment-like-forms')
  commentForms.forEach((form) => {
    form.addEventListener('submit', function (event) {
      event.preventDefault()
      const commentId = event.target.dataset.commentId
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

      axios({
        method: 'post',
        url: `http://127.0.0.1:8080/reviews/${commentId}/comment_likes/`,
        headers: { 'X-CSRFToken': csrftoken },
      })
        .then((response) => {
          const isCommentLiked = response.data.is_commentliked
          const commentLikeBtn = document.querySelector(`#likes_comment-${commentId}`)
          const commentLikes = commentLikeBtn.querySelector('p')
          const commentLikeIcon = commentLikeBtn.querySelector('svg')

          if (isCommentLiked === true) {
            commentLikeIcon.innerHTML = '<g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="Interface / Heart_01"> <path id="Vector" d="M12 7.69431C10 2.99988 3 3.49988 3 9.49991C3 15.4999 12 20.5001 12 20.5001C12 20.5001 21 15.4999 21 9.49991C21 3.49988 14 2.99988 12 7.69431Z" stroke="#ff4d4d" fill="#ff4d4d" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path> </g> </g>'
            commentLikes.textContent = parseInt(commentLikes.textContent) + 1
          } else {
            commentLikeIcon.innerHTML = '<g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="Interface / Heart_01"> <path id="Vector" d="M12 7.69431C10 2.99988 3 3.49988 3 9.49991C3 15.4999 12 20.5001 12 20.5001C12 20.5001 21 15.4999 21 9.49991C21 3.49988 14 2.99988 12 7.69431Z" stroke="#98A0A0" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path> </g> </g>'
            commentLikes.textContent = parseInt(commentLikes.textContent) - 1
          }
        })
    })
  })
</script>
{% endblock script %}
