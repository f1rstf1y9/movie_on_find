{% extends 'base.html' %}
{% load static %}

{% block style %}
p {
  margin-bottom: 0;
}
a {
  color: white;
}
ul {
  padding-left: 0;
}
li {
  list-style: none;
}
button {
  background: none;
  border: none;
  outline: 0;
  color: white;
}
.container {
  max-width: 700px;
  margin: 75px auto;
}

.user-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
}
.user-header > div {
  display: flex;
  align-items: center;
  gap: 10px;
}
.review-profile-image img {
  width: 35px;
  border-radius: 50%;
}
.review-created-time {
  color: rgb(173, 173, 173);
  font-size: 12px;
}
.movie-header {
  border-bottom: 1px solid #5f5f5f;
  padding-bottom: 10px;
}
.movie-header > div > a {
  display: flex;
  align-items: center;
  gap: 20px;
}
.movie-poster img {
  width: 60px;
  border-radius: 6px;
}

.photo_ticket {
  display: flex;
  width: 100%;
  justify-content: space-around;
  margin-top: 10px;
}

.photo_ticket .ticket-item {
  display: flex;
  justify-content: center;
  justify-content: flex-start;
  align-items: center;
  flex-direction: column;
  position: relative;
  user-select: none;
  margin: 10px 0px;
  padding: 16px;
  border-radius: clamp(0px, ((100vw - 4px) - 100%) * 9999, 8px);
  cursor: pointer;
  width: 200px;
  height: 300px;
  background: white;
  color: black;

  box-shadow: 0px 1px 2px 0px rgba(0,0,0,0.35);
  -webkit-box-shadow: 0px 1px 2px 0px rgba(0,0,0,0.35);
  -moz-box-shadow: 0px 1px 2px 0px rgba(0,0,0,0.35);
}

.item-inner {
  position: relative;
  transition: transform 0.8s;
  display: flex;
  gap: 20px;
}
.item-front img {
  aspect-ratio: 1/1;
  width: 175px;
  height: 350px;
  object-fit: cover;
  -webkit-user-drag: none;
  -khtml-user-drag: none;
  -moz-user-drag: none;
  -o-user-drag: none;
  user-drag: none;
  margin-bottom: 16px;
  border-radius: clamp(0px, ((100vw - 4px) - 100%) * 9999, 4px);
}
.item-back {
  position: relative;
  font-size: 14px;
  text-align: left;
}
.item-back > div {
  width: 100%;
  margin-bottom: 10px;
}
.item-back .movie-info-top {
  font-size: 12px;
  display: flex;
  justify-content: space-between;
}
.item-back .movie-info-bottom {
  margin-bottom: 10px;
  border-top: 1px solid #000;
  border-bottom: 1px solid #000;
  padding: 10px 0;
}
.item-back .movie-info-bottom p {
  margin-bottom: 0;
}
.item-back .movie-info-bottom p:first-child {
  font-size: 16px;
  font-weight: bold;
}
.item-back .ticket-date {
  font-size: 12px;
}
.item-back .ticket-barcode {
  position: absolute;
  text-align: center;
  bottom: 10px;
}
{% endblock style %}

{% block content %}
  <div class="user-header">
    <div>
      <div class="review-profile-image">
        <a href="{% url 'accounts:profile' user.email %}">
          <img src="{{ user.profile_image.url }}" alt="{{ user.profile_image }}">
        </a>
      </div>
      <a href="{% url 'accounts:profile' user.email %}">
        <p class="review-profile-nickname">{{ user.nickname }}</p>
      </a>
    </div>
    <p class="review-created-time">{{ card.created_at }}</p>
  </div>
  <div class="movie-header">
    <div class="movie-poster">
      <a href="{% url 'movies:detail' card.movie.pk %}">
        <img src="https://www.themoviedb.org/t/p/w300_and_h450_bestv2/{{ card.movie.poster_path }}" alt="">
        <p>{{ card.movie.title }}</p>
      </a>
    </div>
  </div>

  <div class="photo_ticket">
    <div class="item-inner">
      <div class="ticket-item item-front">
        <img class="photo_ticket__image" src="{{ card.card_image.url }}" alt="{{ card.card_image }}" />
      </div>
      <div class="ticket-item item-back">
          <div class="movie-info-top">
            <p>{{ card.movie_type }}</p>
            <p>{{ card.watched_location }}</p>
          </div>
          <div class="movie-info-bottom">
            <p class="movie-title-ko">{{ movie.title }}</p>
            <p class="movie-title-en">{{ movie.original_title }}</p>
          </div>
          <div class="ticket-date">
            {{ card.watched_date }}
          </div>
          <div class="ticket-comment">
            {{ card.content }}
          </div>
          <div class="ticket-people">
            {{ card.watched_people }}명
          </div>
          <div class="ticket-barcode">
            <img height="45px" src="{% static 'accounts/ticket-barcode.gif' %} " alt="바코드">
          </div>
        </div>
    </div>
  </div>
  <hr>
  <div>
    <form class="like-forms" data-card-id="{{ card.pk }}">
      {% csrf_token %}
      {% if request.user != card.user %}
      {% if request.user in card.like_users.all %}
        <input type="submit" value="좋아요 취소" id="like-{{ card.pk }}">
      {% else %}
        <input type="submit" value="좋아요" id="like-{{ card.pk }}">
      {% endif %}
      {% endif %}
    </form>
  </div>
  {% if request.user == card.user %}
    <a href="{% url 'cards:update' card.pk %}">UPDATE</a>
    <form action="{% url 'cards:delete' card.pk %}" method="POST">
      {% csrf_token %}
      <input type="submit" value="DELETE">
    </form>
  {% endif %}
{% endblock content %}
{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const forms = document.querySelectorAll('.like-forms')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

  forms.forEach((form) => {
    form.addEventListener('submit', function (event) {
      event.preventDefault()
      const cardId = event.target.dataset.cardId
      // headers: {'X-CSRFToken': csrftoken},
      axios({
        method: 'post',
        url: `http://127.0.0.1:8000/cards/${cardId}/likes/`,
        headers: {'X-CSRFToken': csrftoken},
      })
      .then((response) => {
        // like 버튼을 이전에 눌렀는가? 좋아요 / 좋아요 취소를 할지 결정 (서버로 좋아요 여부 받기)
        const isLiked = response.data.is_liked
        const likeBtn = document.querySelector(`#like-${cardId}`)
        const likes=document.querySelector("#likes")
        if (isLiked === true) {
          likeBtn.value = '좋아요 취소'
          likes.textContent=Number(likes.textContent) + 1
        } else {
          likeBtn.value = '좋아요',
          likes.textContent=Number(likes.textContent) - 1
        }
      })
    })
  })
</script>

{% endblock script %}