{% extends 'base.html' %}
{% load bootstrap4 %}
{% block content %}
id: <span data-resdatas-id="{{ resdatas.id }}">{{ resdatas.id }}</span>
<br>
{% for c in comment %}
{{c.content}}
{% endfor %}
title:{{resdatas.title}}
<br>
평점:{{resdatas.vote_average}}
<br>
포스터경로:{{resdatas.poster_path}}
<br>
오버뷰:{{resdatas.overview}}
<br>
장르:
{% for genre_id in resdatas.genre_ids %}
{% for data in datas %}
{% ifequal genre_id data.id %}
{{data.name}}
{% endifequal %}
{% endfor %}
{% endfor %}
<br>
출연진:
{% comment %} {% for data in datas %}
{{data.id}}
<a href="{% url 'movies:actor_detail' data.id%}">{{data.name}}</a>

{{data.profile_path}}
<br>
{% endfor %} {% endcomment %}
<hr>

<a href="{% url 'reviews:create' resdatas.id%}">CREATE REVIEW</a>

<h4>게시글 목록</h4>
{% if reviews %}
    <p>{{ reviews|length }}개의 게시글이 있습니다.</p>
  {% endif %}
  <ul>
    {% for review in reviews %}
    <div>
      {% if review.spoiler == 'True' %}
      스포방지
      {% else %}
      스포일러
      {% endif %}
      <li>
        {{ review.user }}
        <br>
        <a href="{% url 'reviews:detail' review.id%}">{{ review.title }}</a>
       
        <br>
        {{review.content}}
        <br>
        {{review.vote}}
        <p>좋아요 : <p id="likes">{{ review.like_users.all|length }}</p></p>
        <div>
          <form class="like-forms" data-review-id="{{ review.id }}">
            {% csrf_token %}
            {% if request.user != review.user%}
            {% if request.user in review.like_users.all %}
              <input type="submit" value="좋아요 취소" id="like-{{ review.id }}">
            {% else %}
              <input type="submit" value="좋아요" id="like-{{ review.pk }}">
            {% endif %}
            {% endif %}
          </form>
        </div>
      </li>
    </div>
    {% empty %}
      <li>게시글이 없어요...</li>
    {% endfor %}
  </ul>
  <hr>
  <br>
  {% if request.user.is_authenticated %}
<div>
<a href="{% url 'cards:create' resdatas.id%}">CREATE CARD</a>
</div>
{% endif %}
<hr>
{% if cards %}
    <p>{{ cards|length }}개의 카드가 있습니다.</p>
  {% endif %}
<ul>
  {% for card in cards %}
  <div>
  title:{{card.title}}
  content:{{card.content}}
  movie_id:{{card.movie_id}}
  이미지:{{resdatas.poster_path}}
</div>
  {% endfor %}
</ul>
<a href="{% url 'movies:index' %}">뒤로가기</a>

{% endblock content %}



{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const forms = document.querySelectorAll('.like-forms');
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

  forms.forEach((form) => {
    form.addEventListener('submit', function (event) {
      event.preventDefault()
      const reviewId = event.target.dataset.reviewId
      // headers: {'X-CSRFToken': csrftoken},
      axios({
        method: 'post',
        url: `http://127.0.0.1:8000/reviews/${reviewId}/likes/`,
        headers: {'X-CSRFToken': csrftoken},
      })
      .then((response) => {
        // like 버튼을 이전에 눌렀는가? 좋아요 / 좋아요 취소를 할지 결정 (서버로 좋아요 여부 받기)
        const isLiked = response.data.is_liked
        const likeBtn = document.querySelector(`#like-${reviewId}`)
        const likes=document.querySelector("#likes")

        if (isLiked === true) {
          likeBtn.value = '좋아요 취소'
          likes.textContent=Number(likes.textContent) + 1
        
        } else {
          likeBtn.value = '좋아요',
          likes.textContent=Number(likes.textContent) - 1

        }
      })


    })
  })

</script>

{% endblock script %}